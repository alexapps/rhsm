package licensecontroller

import (
	"testing"

	"github.com/onsi/gomega"
)

func TestGetEntitlements(t *testing.T) {
	g := gomega.NewGomegaWithT(t)
	rawBody := []byte(`[{"created":"2020-10-20T12:36:37+0000","updated":"2020-10-20T12:36:37+0000","id":"ddbff76bcf194a8c85ebd30c0313a5f4","consumer":{"id":"8a85f993752e49a9017545e80f0d5bc6","uuid":"7dc235f0-0e69-4be0-b96d-b54315969ee8","name":"rhel-vd02.bud.mirantis.net","href":"/consumers/7dc235f0-0e69-4be0-b96d-b54315969ee8"},"pool":{"created":"2020-10-19T10:46:42+0000","updated":"2020-10-21T13:31:36+0000","id":"8a85f98d752e433801754077eccc2f6a","type":"STACK_DERIVED","owner":{"id":"8a85f98739a09c7d0139a33288610e0b","key":"6706365","displayName":"6706365","href":"/owners/6706365"},"activeSubscription":true,"sourceEntitlement":null,"quantity":-1,"startDate":"2020-10-07T04:00:00+0000","endDate":"2021-10-07T03:59:59+0000","attributes":[{"name":"requires_host","value":"9d0d5549-7320-4bc4-8aeb-b80c7ae5440f"},{"name":"pool_derived","value":"true"},{"name":"virt_only","value":"true"},{"name":"physical_only","value":"false"},{"name":"requires_consumer_type","value":"system"}],"restrictedToUsername":null,"contractNumber":"12476743","accountNumber":"1641452","orderNumber":"40499547","consumed":1,"exported":0,"branding":[{"created":"2020-10-07T17:55:27+0000","updated":"2020-10-07T17:55:27+0000","productId":"69","name":"RedHatEnterpriseLinux","type":"OS"},{"created":"2020-10-07T17:55:27+0000","updated":"2020-10-07T17:55:27+0000","productId":"491","name":"RedHatEnterpriseLinux","type":"OS"},{"created":"2020-10-07T17:55:27+0000","updated":"2020-10-07T17:55:27+0000","productId":"479","name":"RedHatEnterpriseLinux","type":"OS"}],"calculatedAttributes":{"compliance_type":"Standard"},"upstreamPoolId":null,"upstreamEntitlementId":null,"upstreamConsumerId":null,"productName":"RedHatEnterpriseLinuxforVirtualDatacenters,Standard","productId":"RH00050","productAttributes":[{"name":"host_limited","value":"true"},{"name":"product_family","value":"RedHatEnterpriseLinux"},{"name":"management_enabled","value":"1"},{"name":"enabled_consumer_types","value":"SAM"},{"name":"ph_product_line","value":"RHEL"},{"name":"usage","value":"Production"},{"name":"roles","value":"RedHatEnterpriseLinuxServer"},{"name":"ph_category","value":"Subscriptions"},{"name":"description","value":"RedHatEnterpriseLinux"},{"name":"support_level","value":"Standard"},{"name":"type","value":"MKT"},{"name":"option_code","value":"68"},{"name":"ph_product_name","value":"RHELServer"},{"name":"service_type","value":"Standard"},{"name":"expires_after","value":"365"},{"name":"subtype","value":"Standard"},{"name":"variant","value":"PhysicalServer"},{"name":"name","value":"RedHatEnterpriseLinuxforVirtualDatacenters,Standard"},{"name":"support_type","value":"L1-L3"},{"name":"arch","value":"ia,ia64,x86,x86_64"}],"stackId":null,"stacked":false,"sourceStackId":"RH00002","developmentPool":false,"derivedProductAttributes":[],"derivedProductId":null,"derivedProductName":null,"providedProducts":[{"productId":"240","productName":"OracleJava(forRHELServer)"},{"productId":"201","productName":"RedHatSoftwareCollections(forRHELServer)"},{"productId":"491","productName":"RedHatCodeReadyLinuxBuilderforx86_64"},{"productId":"408","productName":"RedHatAnsibleEngine"},{"productId":"272","productName":"RedHatEnterpriseLinuxAtomicHostBeta"},{"productId":"271","productName":"RedHatEnterpriseLinuxAtomicHost"},{"productId":"394","productName":"RedHatDeveloperTools(forRHELServer)"},{"productId":"180","productName":"RedHatBeta"},{"productId":"205","productName":"RedHatSoftwareCollectionsBeta(forRHELServer)"},{"productId":"69","productName":"RedHatEnterpriseLinuxServer"},{"productId":"395","productName":"RedHatDeveloperToolsBeta(forRHELServer)"},{"productId":"479","productName":"RedHatEnterpriseLinuxforx86_64"},{"productId":"176","productName":"RedHatDeveloperToolset(forRHELServer)"},{"productId":"317","productName":"dotNETonRHEL(forRHELServer)"}],"derivedProvidedProducts":[],"subscriptionSubKey":null,"subscriptionId":null,"locked":false,"href":"/pools/8a85f98d752e433801754077eccc2f6a"},"quantity":1,"certificates":[{"created":"2020-10-20T12:36:37+0000","updated":"2020-10-20T12:36:37+0000","id":"8a85f990752e475401754602ebc95dc2","key":"-----BEGINRSAPRIVATEKEY-----\nMIIJJwIBAAKCAgEAkHnGnvSiHxWx4w0sYg==\n-----ENDRSAPRIVATEKEY-----\n","cert":"-----BEGINCERTIFICATE-----\nMIIKhjC4n1uKoUU64yQ+Q1P/5KIG/J8kml6mFmeo=\n-----ENDRSASIGNATURE-----\n","serial":{"created":"2020-10-20T12:36:37+0000","updated":"2020-10-20T12:36:37+0000","id":7024108699601186219,"serial":7024108699601186219,"expiration":"2021-10-07T03:59:59+0000","collected":false,"revoked":false}}],"startDate":"2020-10-07T04:00:00+0000","endDate":"2021-10-07T03:59:59+0000","href":"/entitlements/ddbff76bcf194a8c85ebd30c0313a5f4"}]`)
	entitlements, err := getEntitlements(rawBody)
	g.Expect(err).NotTo(gomega.HaveOccurred())
	g.Expect(len(entitlements)).To(gomega.Equal(1))
	g.Expect(entitlements[0].ID).To(gomega.Equal("ddbff76bcf194a8c85ebd30c0313a5f4"))

}
